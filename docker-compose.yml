version: "3.9"

services:
  postgres_keycloak:
    image: postgres:14
    container_name: keycloak_postgres
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_KEYCLOAK_DB}
      POSTGRES_USER: ${POSTGRES_KEYCLOAK_USER}
      POSTGRES_PASSWORD: ${POSTGRES_KEYCLOAK_PASSWORD}
    ports:
      - "${POSTGRES_KEYCLOAK_PORT}:5432"
    volumes:
      - postgres_keycloak_data:/var/lib/postgresql/data
    networks:
      - idnet

  postgres_identity:
    image: postgres:14
    container_name: postgres_identity
    environment:
      POSTGRES_DB: ${POSTGRES_IDENTITY_DB}
      POSTGRES_USER: ${POSTGRES_IDENTITY_USER}
      POSTGRES_PASSWORD: ${POSTGRES_IDENTITY_PASSWORD}
    ports:
      - "${POSTGRES_IDENTITY_PORT}:5432"
    volumes:
      - postgres_identity_data:/var/lib/postgresql/data
    networks:
      - idnet

  postgres_userProfile:
    image: postgres:14
    container_name: postgres_userProfile
    environment:
      POSTGRES_DB: ${POSTGRES_USER_PROFILE_DB}
      POSTGRES_USER: ${POSTGRES_USER_PROFILE_USER}
      POSTGRES_PASSWORD: ${POSTGRES_USER_PROFILE_PASSWORD}
    ports:
      - "${POSTGRES_USER_PROFILE_DB_PORT}:5432"
    volumes:
      - postgres_userProfile_data:/var/lib/postgresql/data
    networks:
      - idnet

  postgres_course:
    image: postgres:14
    container_name: postgres_course
    environment:
      POSTGRES_DB: ${POSTGRES_COURSE_DB}
      POSTGRES_USER: ${POSTGRES_COURSE_USER}
      POSTGRES_PASSWORD: ${POSTGRES_COURSE_PASSWORD}
    ports:
      - "${POSTGRES_COURSE_PORT}:5432"
    volumes:
      - postgres_course_data:/var/lib/postgresql/data
    networks:
      - idnet

  postgres_dashboard:
    image: postgres:14
    container_name: postgres_dashboard
    environment:
      POSTGRES_DB: ${POSTGRES_DASHBOARD_DB}
      POSTGRES_USER: ${POSTGRES_DASHBOARD_USER}
      POSTGRES_PASSWORD: ${POSTGRES_DASHBOARD_PASSWORD}
    ports:
      - "${POSTGRES_DASHBOARD_PORT}:5432"
    volumes:
      - postgres_dashboard_data:/var/lib/postgresql/data
    networks:
      - idnet

  postgres_assessment:
    image: postgres:14
    container_name: postgres_assessment
    environment:
      POSTGRES_DB: ${POSTGRES_ASSESSMENT_DB}
      POSTGRES_USER: ${POSTGRES_ASSESSMENT_USER}
      POSTGRES_PASSWORD: ${POSTGRES_ASSESSMENT_PASSWORD}
    ports:
      - "${POSTGRES_ASSESSMENT_PORT}:5432"
    volumes:
      - postgres_assessment_data:/var/lib/postgresql/data
    networks:
      - idnet

  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: rabbitmq
    ports:
      - "5672:5672" # AMQP port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - idnet

  eureka:
    build:
      context: .
      dockerfile: ./dockerfile/Dockerfile.eureka-server
    container_name: eureka-server
    ports:
      - "${EUREKA_PORT}:8761"
    networks:
      - idnet

  keycloak:
    image: quay.io/keycloak/keycloak:26.4
    container_name: keycloak_server
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_DB: ${KEYCLOAK_DB}
      KC_DB_URL: ${KEYCLOAK_DB_URL}
      KC_DB_USERNAME: ${KEYCLOAK_DB_USERNAME}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
    command: ["start-dev", "--import-realm"]
    ports:
      - "${KEYCLOAK_EXTERNAL_PORT}:${KEYCLOAK_INTERNAL_PORT}"
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    depends_on:
      - postgres_keycloak
    networks:
      - idnet

  gateway:
    build:
      context: .
      dockerfile: ./dockerfile/Dockerfile.api-gateway
    container_name: api-gateway
    ports:
      - "${GATEWAY_PORT}:8181"
    environment:
      WEB_CLIENT_URL_IP: ${WEB_CLIENT_URL_IP}
      WEB_CLIENT_URL_DNS: ${WEB_CLIENT_URL_DNS}
      WEB_CLIENT_URL_DEV: ${WEB_CLIENT_URL_DEV}
      EUREKA_SERVER: ${EUREKA_SERVER}
      EUREKA_HOST: eureka
      JWT_SECRET: ${JWT_SECRET:-your-256-bit-secret-key-change-this-in-production-please-make-it-long-enough}
    depends_on:
      - eureka
    networks:
      - idnet

  identity-service:
    build:
      context: .
      dockerfile: ./dockerfile/Dockerfile.identity-service
    container_name: identity-service
    ports:
      - "${IDENTITY_SERVICE_PORT}:${IDENTITY_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${IDENTITY_SERVICE_PORT}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: ${DATASOURCE_URL_IDENTITY}
      SPRING_DATASOURCE_USERNAME: ${DATASOURCE_USERNAME_IDENTITY}
      SPRING_DATASOURCE_PASSWORD: ${DATASOURCE_PASSWORD_IDENTITY}
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_SERVER_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      KEYCLOAK_ISSUER_URI: ${KEYCLOAK_ISSUER_URI}
      EUREKA_SERVER: ${EUREKA_SERVER}
      DB_HOST: ${POSTGRES_IDENTITY_HOST}
      DB_PORT: ${POSTGRES_PORT_DEFAULT}
      DB_NAME: ${POSTGRES_IDENTITY_DB}
      JWT_ISSUER_URI: ${JWT_ISSUER_URI}
    depends_on:
      - postgres_identity
      - keycloak
      - eureka
    networks:
      - idnet
  user-profile-service:
    build:
      context: .
      dockerfile: ./dockerfile/Dockerfile.user-profile-service
    container_name: user-profile-service
    ports:
      - "${USER_PROFILE_SERVICE_PORT}:${USER_PROFILE_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${USER_PROFILE_SERVICE_PORT}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: ${DATASOURCE_URL_USER_PROFILE}
      SPRING_DATASOURCE_USERNAME: ${DATASOURCE_USERNAME_USER_PROFILE}
      SPRING_DATASOURCE_PASSWORD: ${DATASOURCE_PASSWORD_USER_PROFILE}
      EUREKA_SERVER: ${EUREKA_SERVER}
      JWT_ISSUER_URI: ${JWT_ISSUER_URI}
      RABBITMQ_HOST: ${RABBITMQ_HOST}
      RABBITMQ_PORT: ${RABBITMQ_PORT}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      DB_HOST: ${POSTGRES_USER_PROFILE_HOST}
      DB_PORT: ${POSTGRES_PORT_DEFAULT}
      DB_NAME: ${POSTGRES_USER_PROFILE_DB}
      JWT_SECRET: ${JWT_SECRET:-your-256-bit-secret-key-change-this-in-production-please-make-it-long-enough}
    depends_on:
      - postgres_userProfile
      - rabbitmq
      - eureka
      - keycloak
    networks:
      - idnet

  course-service:
    build:
      context: .
      dockerfile: ./dockerfile/Dockerfile.course-service
    container_name: course-service
    ports:
      - "${COURSE_SERVICE_PORT}:${COURSE_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${COURSE_SERVICE_PORT}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: ${DATASOURCE_URL_COURSE}
      SPRING_DATASOURCE_USERNAME: ${DATASOURCE_USERNAME_COURSE}
      SPRING_DATASOURCE_PASSWORD: ${DATASOURCE_PASSWORD_COURSE}
      EUREKA_SERVER: ${EUREKA_SERVER}
      JWT_ISSUER_URI: ${JWT_ISSUER_URI}
      JWT_JWK_SET_URI: ${JWT_JWK_SET_URI}
      RABBITMQ_HOST: ${RABBITMQ_HOST}
      RABBITMQ_PORT: ${RABBITMQ_PORT}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      DB_HOST: ${POSTGRES_COURSE_HOST}
      DB_PORT: ${POSTGRES_PORT_DEFAULT}
      DB_NAME: ${POSTGRES_COURSE_DB}
      USER_PROFILE_SERVICE_URL: ${USER_PROFILE_SERVICE_URL}
      JWT_SECRET: ${JWT_SECRET:-your-256-bit-secret-key-change-this-in-production-please-make-it-long-enough}
    depends_on:
      - postgres_course
      - rabbitmq
      - eureka
      - keycloak
    networks:
      - idnet

  dashboard-service:
    build:
      context: .
      dockerfile: ./dockerfile/Dockerfile.dashboard-service
    container_name: dashboard-service
    ports:
      - "${DASHBOARD_SERVICE_PORT}:${DASHBOARD_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${DASHBOARD_SERVICE_PORT}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: ${DATASOURCE_URL_DASHBOARD}
      SPRING_DATASOURCE_USERNAME: ${DATASOURCE_USERNAME_DASHBOARD}
      SPRING_DATASOURCE_PASSWORD: ${DATASOURCE_PASSWORD_DASHBOARD}
      EUREKA_SERVER: ${EUREKA_SERVER}
      JWT_ISSUER_URI: ${JWT_ISSUER_URI}
      RABBITMQ_HOST: ${RABBITMQ_HOST}
      RABBITMQ_PORT: ${RABBITMQ_PORT}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      DB_HOST: ${POSTGRES_DASHBOARD_HOST}
      DB_PORT: ${POSTGRES_PORT_DEFAULT}
      DB_NAME: ${POSTGRES_DASHBOARD_DB}
      ASSESSMENT_SERVICE_URL: ${ASSESSMENT_SERVICE_URL}
      USER_PROFILE_SERVICE_URL: ${USER_PROFILE_SERVICE_URL}
      COURSE_SERVICE_URL: ${COURSE_SERVICE_URL}
      JWT_SECRET: ${JWT_SECRET:-your-256-bit-secret-key-change-this-in-production-please-make-it-long-enough}
    depends_on:
      - postgres_dashboard
      - rabbitmq
      - eureka
      - keycloak
    networks:
      - idnet

  assessment-service:
    build:
      context: .
      dockerfile: ./dockerfile/Dockerfile.assessment-service
    container_name: assessment-service
    ports:
      - "${ASSESSMENT_SERVICE_PORT}:${ASSESSMENT_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${ASSESSMENT_SERVICE_PORT}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: ${DATASOURCE_URL_ASSESSMENT}
      SPRING_DATASOURCE_USERNAME: ${DATASOURCE_USERNAME_ASSESSMENT}
      SPRING_DATASOURCE_PASSWORD: ${DATASOURCE_PASSWORD_ASSESSMENT}
      EUREKA_SERVER: ${EUREKA_SERVER}
      JWT_ISSUER_URI: ${JWT_ISSUER_URI}
      RABBITMQ_HOST: ${RABBITMQ_HOST}
      RABBITMQ_PORT: ${RABBITMQ_PORT}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      DB_HOST: ${POSTGRES_ASSESSMENT_HOST}
      DB_PORT: ${POSTGRES_PORT_DEFAULT}
      DB_NAME: ${POSTGRES_ASSESSMENT_DB}
      JWT_SECRET: ${JWT_SECRET:-your-256-bit-secret-key-change-this-in-production-please-make-it-long-enough}
    depends_on:
      - postgres_assessment
      - rabbitmq
      - eureka
      - keycloak
    networks:
      - idnet

  # gateway_dev:
  #   image: its-gateway
  #   container_name: api-gateway-dev
  #   ports:
  #     - "${GATEWAY_DEV_PORT}:8181"
  #   volumes:
  #     - ./backend/java-service/api-gateway/src:/app/src
  #     - ./backend/java-service/api-gateway/target/classes:/app/target/classes
  #   restart: always
  #   networks:
  #     - idnet

volumes:
  postgres_keycloak_data:
  postgres_identity_data:
  postgres_userProfile_data:
  postgres_course_data:
  postgres_dashboard_data:
  postgres_assessment_data:
  rabbitmq_data:

networks:
  idnet:
    driver: bridge
